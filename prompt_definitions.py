# prompt_definitions.py
# -*- coding: utf-8 -*-
"""
集中存放所有提示词 (Prompt)，整合雪花写作法、角色弧光理论、悬念三要素模型等
并包含新增加的前三章摘要/下一章关键字提炼提示词，以及章节正文写作提示词。
"""

# =============== 生成草稿提示词当前章节摘要、知识库提炼 ===============
# 当前章节摘要生成提示词
summarize_recent_chapters_prompt = """\
作为一名专业的小说编辑和知识管理专家，正在基于已完成的前三章内容和本章信息生成当前章节的精准摘要。请严格遵循以下工作流程：
前三章内容：
{combined_text}

当前章节信息：
第{novel_number}章《{chapter_title}》：
├── 本章定位：{chapter_role}
├── 核心作用：{chapter_purpose}
├── 悬念密度：{suspense_level}
├── 伏笔操作：{foreshadowing}
├── 认知颠覆：{plot_twist_level}
├── 主角修为：表面修为{surface_cultivation} | 实际实力{actual_cultivation}
├── 空间坐标：{spatial_coordinates}
└── 本章简述：{chapter_summary}

下一章信息：
第{next_chapter_number}章《{next_chapter_title}》：
├── 本章定位：{next_chapter_role}
├── 核心作用：{next_chapter_purpose}
├── 悬念密度：{next_chapter_suspense_level}
├── 伏笔操作：{next_chapter_foreshadowing}
├── 认知颠覆：{next_chapter_plot_twist_level}
├── 主角修为：表面修为{next_surface_cultivation} | 实际实力{next_actual_cultivation}
├── 空间坐标：{next_spatial_coordinates}
└── 本章简述：{next_chapter_summary}

**上下文分析阶段**：
1. 回顾前三章核心内容：
   - 第一章核心要素：[章节标题]→[核心冲突/理论]→[关键人物/概念]
   - 第二章发展路径：[已建立的人物关系]→[技术/情节进展]→[遗留伏笔]
   - 第三章转折点：[新出现的变量]→[世界观扩展]→[待解决问题]
2. 提取延续性要素：
   - 必继承要素：列出前3章中必须延续的3个核心设定
   - 可调整要素：识别2个允许适度变化的辅助设定
   - 修为、装备、空间坐标、时间压力等禁止偏离前3章设定

**当前章节摘要生成规则**：
1. 内容架构：
   - 继承权重：70%内容需与前3章形成逻辑递进
   - 创新空间：30%内容可引入新要素，但需标注创新类型（如：技术突破/人物黑化）
2. 结构控制：
   - 采用"承继→发展→铺垫"三段式结构
   - 每段含1个前文呼应点+1个新进展
3. 预警机制：
   - 若检测到与前3章设定冲突，用[!]标记并说明
   - 对开放式发展路径，提供2种合理演化方向

现在请你基于目前故事的进展，完成以下两件事：
用最多800字，写一个简洁明了的「当前章节摘要」；

请按如下格式输出（不需要额外解释）：
当前章节摘要: <这里写当前章节摘要>
"""

# 知识库相关性检索提示词
knowledge_search_prompt = """\
请基于以下当前写作需求，生成合适的知识库检索关键词：

## 知识库结构说明
知识库包含以下类型和分类：
- 玄幻修真类型：场景构建模板、悬念营造手法、对话写作技巧、视角切换技巧、时间跳跃与回忆穿插、多线并进冲突集中爆发、伏笔的长线铺设、个人物品及状态盘点
- 通用写作类型：场景构建模板、悬念营造手法、对话写作技巧

## 章节元数据

### 基础信息
- 章节编号：{chapter_number}
- 章节标题：{chapter_title}
- 章节定位：{chapter_role}
- 核心作用：{chapter_purpose}

### 叙事维度
- 情节类型：{plot_type}
- 情节张力：{tension_level}
- 情节焦点：{plot_focus}
- 伏笔类型：{foreshadowing_type}

### 角色维度
- 核心人物：{main_characters}
- 指定人物状态：{character_states}

### 环境维度
- 场景位置：{scene_location}
- 场景特征：{scene_features}
- 时间设定：{time_setting}
- 环境氛围：{atmosphere}

### 物品维度
- 关键道具：{key_items}
- 相关技术/系统：{related_technology}

### 上下文维度
- 前情提要：{previous_summary}
- 当前摘要：{current_summary}
- 后续预期：{future_expectations}
- 用户指导：{user_guidance}

生成规则：

1.关键词组合逻辑：
-类型1：[实体]+[属性]（如"青云剑·剑灵觉醒"）
-类型2：[事件]+[后果]（如"宗门大比·血脉觉醒"）
-类型3：[地点]+[特征]（如"秘境·上古阵法"）
-类型4：[角色]+[状态]（如"主角·走火入魔"）
-类型5：[道具]+[功能]（如"储物戒·空间封印"）

1.5 知识库元数据匹配规则：
- 确保生成的关键词与知识库中的【类型】、【分类】、【关键词】字段对应
- 优先使用知识库中已存在的分类名称作为关键词的一部分
- 关键词组合应能匹配知识库内容中的【关键词】字段

2.优先级规则：
-P0：用户指导中明确提及的术语
-P1：情节焦点相关的内容
-P2：当前章节涉及的核心道具/地点
-P3：人物当前状态相关的信息
-P4：可能关联的扩展概念

3.上下文关联规则：
-根据情节类型自动调整关键词权重：
  * 探索类：提高场景特征、环境氛围权重，优先检索"场景构建模板"分类
  * 冲突类：提高人物状态、道具功能权重，优先检索"悬念营造手法"、"对话写作技巧"分类
  * 揭示类：提高相关技术、世界观权重，优先检索"场景构建模板"、"悬念营造手法"分类
  * 转折类：提高伏笔类型、人物关系权重，优先检索"伏笔的长线铺设"、"悬念营造手法"分类

3.5 知识库分类优先级规则：
- 探索类章节：场景构建模板 > 悬念营造手法 > 对话写作技巧 > 其他分类
- 冲突类章节：悬念营造手法 > 对话写作技巧 > 场景构建模板 > 其他分类
- 揭示类章节：场景构建模板 > 悬念营造手法 > 其他分类
- 转折类章节：伏笔的长线铺设 > 悬念营造手法 > 对话写作技巧 > 其他分类

4.过滤机制：
-排除抽象程度高于"中级"的概念
-排除与前3章重复率超60%的词汇
-根据情节张力调整关键词具体化程度：
  * 张力1-3：使用较宽泛的关键词
  * 张力4-7：使用中等具体度的关键词
  * 张力8-10：使用高度具体的关键词

5.输出要求：
-生成3-5组检索词，按优先级降序排列
-每组用"·"连接2-3个关键词，每组占一行
-每组关键词后添加适用场景说明（括号内）
-高优先级关键词可添加"!"前缀

示例：
! 宗门大比·血脉觉醒（制造危机感）
上古秘境·阵法禁制·机缘（构建悬念）
主角·走火入魔·心魔劫难（人物转折）
"""

# 知识库内容过滤提示词
knowledge_filter_prompt = """\
你是一位专业的知识库内容分析专家，请对检索到的知识库内容进行三级过滤。

## 知识库元数据说明
知识库每条内容包含以下元数据：
- 【类型】：玄幻修真/通用写作
- 【分类】：场景构建模板/悬念营造手法/对话写作技巧/视角切换技巧等
- 【关键词】：与内容相关的关键词组合

**重要**：过滤时必须保留这些元数据，确保后续写作时能精准应用。

## 待过滤内容
{retrieved_texts}

## 当前叙事需求

### 章节信息
- 章节编号：{chapter_number}
- 章节标题：{chapter_title}
- 章节定位：{chapter_role}
- 核心作用：{chapter_purpose}

### 叙事维度
- 情节类型：{plot_type}
- 情节张力：{tension_level}
- 相似度阈值：{similarity_threshold}
- 价值密度要求：{value_density_requirement}

### 过滤目标
- 主要目标：{filter_primary_goal}
- 次要目标：{filter_secondary_goals}

## 过滤流程

### 第一级：冲突检测
1. 重复性检测
   - 删除与已有摘要重复度＞{similarity_threshold}的内容
   - 删除与用户指导高度相似的内容

2. 逻辑一致性检测
   - 标记存在世界观矛盾的内容（使用▲前缀）
   - 标记与人物设定矛盾的内容（使用△前缀）
   - 标记与前文情节矛盾的内容（使用▽前缀）

### 第二级：适配度评分
1. 适配度评分标准（1-10分）
   - 9-10分：完全适配当前章节类型、核心作用和关键要素
   - 7-8分：高度适配当前章节，可稍作调整
   - 5-6分：中度适配，需要较大调整
   - 3-4分：低度适配，仅部分内容可用
   - 1-2分：不适用当前章节

2. 适配度评分依据
   - 知识库分类与章节类型的匹配度
   - 知识库内容与章节核心作用的相关性
   - 知识库内容与关键要素（人物、道具、场景）的关联度
   - 知识库内容与章节张力级别的匹配度

### 第二级：价值评估
1. 关键价值点（❗标记）
   - 提供新的角色关系可能性
   - 包含可转化的隐喻素材
   - 存在至少2个可延伸的细节锚点
   - 能推动当前情节发展的关键信息
   - 可用于制造/解决冲突的要素

2. 次级价值点（·标记）
   - 补充环境细节
   - 提供技术/流程描述
   - 提供背景信息

3. 低价值点（○标记）
   - 通用性描述
   - 过于抽象的概念

2.5 分类价值评估标准：
- 场景构建模板：重点评估空间架构、氛围营造、互动元素的丰富度和适用性
- 悬念营造手法：重点评估悬念构建技巧、张力控制、情节转折的巧妙性
- 对话写作技巧：重点评估潜台词设计、权力关系表现、人物性格刻画
- 视角切换技巧：重点评估视角转换流畅度、信息呈现效果、读者代入感
- 时间跳跃与回忆穿插：重点评估时间线清晰度、回忆与现实的衔接、情感渲染效果
- 多线并进冲突集中爆发：重点评估多线交织的合理性、冲突爆发的张力、节奏控制
- 伏笔的长线铺设：重点评估伏笔的隐蔽性、后续呼应的可能性、情节推动作用
- 个人物品及状态盘点：重点评估物品/状态与人物性格的关联度、情节推动作用

### 第三级：结构重组
1. 分类体系
   - [情节燃料]：可直接推动情节发展的内容
   - [人物维度]：与人物相关的信息
   - [世界碎片]：世界观设定相关内容
   - [叙事技法]：可借鉴的写作技巧
   - [环境氛围]：场景和氛围相关内容
   - [冲突素材]：可用于制造/解决冲突的要素

2. 适用场景提示
   - 为每个分类添加适用场景提示
   - 标注该内容最适用的情节类型
   - 标注该内容最适用的张力级别

## 输出格式
[分类名称]→[适用场景]
❗/·/○ [内容片段] （▲/△/▽冲突提示）
...

示例：
[情节燃料]→[时间压力类悬念][张力级别8-10]
❗ 宗门灵脉仅剩三成灵气（可制造生存危机）
▲ 与第三章提到的"万载不竭灵脉"存在设定冲突

[人物维度]→[人物关系转折][张力级别6-8]
· 主角与师尊的传音玉简记录显示理念分歧（可制造人物冲突）

[世界碎片]→[世界观揭示][张力级别4-6]
○ 上古遗迹中记载的失落功法（背景补充）

仅给出最终文本，不要解释任何内容。
提示词：内容
"""

# =============== 1. 核心种子设定（雪花第1层）===================
core_seed_prompt = """\
作为专业作家，请用"雪花写作法"第一步构建故事核心：
主题：{topic}
类型：{genre}
篇幅：约{number_of_chapters}章（每章{word_number}字）

请用单句公式概括故事本质，参考以下模板并根据类型灵活运用：

【玄幻/修真类】
"当[主角]在[起始境遇/修为境界]遭遇[核心事件/机缘/危机]，必须踏上[修炼之路/关键旅程]突破[境界/桎梏]，否则[宗门/家族/世界的覆灭/自身的陨落]；与此同时，[上古魔劫/天道崩坏/异族入侵/远古封印松动]正在暗中逼近。"

【冒险/奇幻类】
"当[主角]在[起始境遇]遭遇[核心事件]，必须踏上[关键旅程]寻找[目标]，否则[灾难后果]；与此同时，[隐藏的更大危机]正在暗中逼近。"

【悬疑/推理类】
"当[主角]发现[关键线索]，必须[关键行动]揭露[真相]，否则[灾难后果]；与此同时，[幕后黑手]正在[更大的阴谋]中布局。"

【都市/情感类】
"当[主角]在[生活境遇]遭遇[核心事件]，必须[关键行动]解决[困境]，否则[人生/情感灾难]；与此同时，[潜在的情感/社会危机]正在酝酿。"

【科幻/未来类】
"当[主角]在[未来世界]发现[核心事件]，必须[关键行动]阻止[灾难]，否则[人类/文明的毁灭]；与此同时，[更大的宇宙/技术危机]正在孕育。"

【历史/权谋类】
"当[主角]在[历史背景]遭遇[核心事件]，必须[关键行动]达成[目标]，否则[家族/国家/王朝的覆灭]；与此同时，[更大的政治/社会危机]正在发酵。"

【成长/励志类】
"当[主角]在[人生阶段]遭遇[核心事件]，必须[关键行动]实现[成长目标]，否则[人生/理想的失败]；与此同时，[内在的心理/性格危机]正在考验他。"

要求：
1. 必须包含显性冲突与潜在危机
2. 体现人物核心驱动力与成长弧光
3. 暗示世界观关键矛盾与故事张力
4. 使用50-150字精准表达，语言凝练有力
5. 确保核心事件、关键行动、灾难后果三要素紧密关联

仅返回故事核心文本，不要解释任何内容。
"""

# =============== 2. 角色动力学设定（角色弧光模型）===================
character_dynamics_prompt = """\
基于以下元素：
- 核心种子：{core_seed}
- 世界观：{world_building}

用户内容要求：
{user_guidance}

请严格按照以下格式设计3-6个具有动态变化潜力的核心角色：

【角色1】
特征：
- 背景、外貌、性别、年龄、职业等
- 暗藏的秘密或潜在弱点(可与世界观或其他角色有关)
- 主修功法/技能体系（可与世界观设定的修炼体系相关联）

核心驱动力三角：
- 表面追求（物质目标）
- 深层渴望（情感需求）
- 灵魂需求（哲学层面）

角色弧线设计：
初始状态 → 触发事件 → 认知失调 → 蜕变节点 → 最终状态

关系冲突网：
- 与其他角色的关系或对立点
- 与至少两个其他角色的价值观冲突
- 一个合作纽带
- 一个隐藏的背叛可能性

【角色2】
（同上格式）

...

要求：
1. 严格按照上述格式输出，不要改变格式结构
2. 用户内容要求仅影响角色设计的内容，不影响输出格式
3. 仅给出最终文本，不要解释任何内容
"""

# =============== 3. 世界构建矩阵（四维度交织法）===================
world_building_prompt = """\
基于以下元素：
- 核心冲突："{core_seed}"

用户内容要求：
{user_guidance}

请严格按照以下格式构建四维交织的世界观：

【物理维度】
1. 空间架构
   - 世界地图：[层级结构：下界→中界→上界，尽可能多且复杂的为各层级划分多个界域，每个界域包含30个以上重要地点]
   - 空间节点：[重要地点：宗门、秘境、禁地、遗迹]
   - 空间通道：[传送阵、空间裂缝、传送门]
   - 空间特性：[重力、灵气浓度、特殊规则]

2. 时间架构
   - 历史纪元：[上古纪元→中古纪元→近古纪元→现代]
   - 关键事件年表：[至少10个重大历史事件]
   - 时间流速：[不同界域的时间流速差异]
   - 时间节点：[特殊时间点：天劫日、盛会期、封印松动期]

3. 力量体系
   - 修炼等级：[每个境界的详细划分：初期、中期、后期、圆满]
   - 修炼路径：[不同种族的修炼体系：人修、魔修、妖修、鬼修、佛修]
   - 力量来源：[天地灵气、血脉传承、天地法则、神魂之力]
   - 境界突破：[突破条件、失败后果、天劫机制]

4. 物品体系
   - 装备体系：[武器、防具、饰品、法宝等级划分]
   - 灵药丹药：[品级划分、功效分类、稀有度]
   - 符箓体系：[功能分类、使用限制、绘制难度]
   - 阵法体系：[类型分类、威力等级、破解难度]
   - 宠物体系：[灵兽、妖兽、神兽等级划分]

【社会维度】
1. 权力结构
   - 等级制度：[修为等级与社会地位的关系]
   - 组织架构：[宗门、家族、联盟、皇朝的权力结构]
   - 权力断层线：[可引发冲突的阶层/种族/组织矛盾]
   - 权力制衡：[各势力间的平衡机制]

2. 经济体系
   - 货币体系：[灵石、灵币、贡献点等货币的兑换关系]
   - 资源分布：[灵石矿脉、灵药产地、秘境资源分布]
   - 贸易网络：[交易市场、拍卖行、黑市、跨境贸易]
   - 经济命脉：[资源争夺焦点、垄断资源、战略资源]

3. 文化体系
   - 修炼文化：[修炼理念、修炼禁忌、修炼传统]
   - 宗教信仰：[供奉的仙神、信仰体系、宗教仪式]
   - 文化禁忌：[可被打破的禁忌及其后果]
   - 文化传承：[功法传承、秘术传承、血脉传承]

4. 组织体系
   - 正道势力：[宗门联盟、正道盟、散修联盟]
   - 魔道势力：[魔道宗门、魔族势力、邪修组织]
   - 中立势力：[商会联盟、情报组织、雇佣兵团]
   - 特殊势力：[隐世宗门、上古传承、神秘组织]

【隐喻维度】
1. 符号系统
   - 视觉符号：[反复出现的意象：剑、镜、莲花、星辰等]
   - 颜色符号：[不同颜色代表的含义：金色=仙道、红色=魔道等]
   - 动物符号：[神兽象征、妖兽象征、灵兽象征]
   - 自然符号：[雷电、火焰、冰霜等自然元素的象征意义]

2. 主题映射
   - 气候/环境变化映射的心理状态
   - 建筑风格暗示的文明困境
   - 修炼境界映射的人生阶段
   - 力量等级映射的社会地位

3. 哲学内核
   - 因果论逻辑：[由因及果，由果推因]
   - 阴阳平衡：[正邪对立、阴阳调和]
   - 道法自然：[顺应天道、逆天而行]
   - 众生平等：[修为与德行的关系]
   - 五行生克：[五行属性功法、灵力、灵石、草药、丹药、阵法、符箓等元素必须遵循五行相生、五行相克关系]

【交互维度】
1. 维度间交互规则
   - 物理与社会维度的交互：[修为等级与社会地位的关系]
   - 社会与隐喻维度的交互：[文化禁忌与修炼理念的关系]
   - 隐喻与物理维度的交互：[符号系统与空间架构的关系]

2. 动态演化机制
   - 世界观演化：[随着剧情发展，世界观如何变化]
   - 势力消长：[各势力力量的变化规律]
   - 资源枯竭：[灵气衰减、资源枯竭的机制]

3. 破坏点与修复机制
   - 世界观漏洞：[可被打破的规则、可被利用的漏洞]
   - 破坏后果：[打破规则后的后果、世界崩塌的机制]
   - 修复机制：[修复漏洞的方法、重建秩序的途径]

要求：
1. 严格按照上述格式输出，不要改变格式结构
2. 每个维度至少包含3个可与角色决策产生互动的动态元素
3. 每个维度至少包含2个可引发冲突的矛盾点
4. 每个维度至少包含1个可被打破的规则
5. 维度间至少包含3个交互规则
6. 用户内容要求仅影响世界观设计的内容，不影响输出格式
7. 仅给出最终文本，不要解释任何内容
"""

# =============== 4. 情节架构（三幕式悬念）===================
plot_architecture_prompt = """\
基于以下元素：
- 核心种子：{core_seed}
- 角色体系：{character_dynamics}
- 世界观：{world_building}

用户内容要求：
{user_guidance}

请严格按照以下格式设计三幕式情节架构：
【第一幕：触发】 
- 日常状态中的异常征兆（3处铺垫）
- 引出故事：展示主线、暗线、副线的开端
- 关键事件：打破平衡的催化剂（需改变至少3个角色的关系）
- 错误抉择：主角的认知局限导致的错误反应

【第二幕：对抗】
- 剧情升级：主线+副线的交叉点
- 双重压力：外部障碍升级+内部挫折
- 虚假胜利：看似解决实则深化危机的转折点
- 灵魂黑夜：世界观认知颠覆时刻

【第三幕：解决】
- 代价显现：解决危机必须牺牲的核心价值
- 嵌套转折：至少包含三层认知颠覆（表面解→新危机→终极抉择）
- 余波：留下2个开放式悬念因子

每个阶段需包含3个关键转折点及其对应的伏笔回收方案。
每个阶段需严格遵循修世界观。
仅给出最终文本，不要解释任何内容。
"""

# =============== 5. 章节目录生成（悬念节奏曲线）===================
chapter_blueprint_prompt = """\
基于以下元素：
- 内容指导：{user_guidance}
- 世界观：
{world_building}
- 小说架构：
{novel_architecture}

设计{number_of_chapters}章的节奏分布：
1. 章节集群划分：
- 每3-5章构成一个悬念单元，包含完整的小高潮，主角修为提升或空间坐标变化
- 每个章节集群需明确主角的修为等级范围和空间坐标范围，且范围适配整体小说架构
- 单元之间设置"认知过山车"（连续2章紧张→1章缓冲）
- 关键转折章需预留多视角铺垫
- 每个单元必须包含以下结构化信息：
  - 单元标题
  - 包含章节数（>=3章）
  - 本单元定位
  - 核心作用
  - 内容摘要
  - 修为等级范围
  - 空间坐标范围
  - 推荐的跨章节写作手法（必须包含：技法名称、应用方式、预期效果）

2. 每章需明确：
- 章节定位：描述本章在整体剧情中的位置和作用（如"开篇引入"、"高潮爆发"、"转折过渡"等）
- 核心作用：描述本章要实现的具体目标（如"建立主角形象"、"揭示关键信息"、"推动主线发展"等）
- 核心悬念类型（信息差/道德困境/时间压力等）
- 情感基调迁移（如从怀疑→恐惧→决绝）
- 伏笔设计（埋设/强化/回收）：
     * 埋设：首次引入某个线索或元素
     * 强化：对已埋设的线索进行加深或扩展
     * 回收：对已埋设的线索进行揭示或解决
     * 注意：伏笔的埋设和回收必须形成闭环，不能只有埋设没有回收
- 转折程度强度（1-5级）
- 主角修为（表面修为与实际实力）
- 空间坐标（区域范围/移动路线/具体地点）

输出格式示例：

第1单元 - 单元标题（包含章节：1-3章）
本单元定位：[定位描述]
核心作用：[作用描述]
内容摘要：[内容摘要]
修为等级范围：[从修为A到修为B]
空间坐标范围：[起始位置 → 移动路线 → 结束位置]
推荐的跨章节写作手法：[技法名称] - [应用方式] - [预期效果]
示例：多线并进冲突集中爆发 - 通过主角线和反派线的交替推进，在第3章集中爆发 - 制造强烈的紧张感和戏剧冲突

第1章 - 章节标题
章节定位：[开篇引入/高潮爆发/转折过渡/...]
核心作用：[建立主角形象/揭示关键信息/推动主线发展/...]
悬念密度：[紧凑/渐进/爆发/...]
伏笔设计：埋设(A线索)→强化(B矛盾)→回收(C悬念)
转折程度：★☆☆☆☆
主角修为：表面修为[境界/等级] | 实际实力[隐藏境界/等级]
空间坐标：[区域范围/移动路线/具体地点]
章节简述：[1-2句话概括本章主要情节，包含：主要事件、关键角色、重要变化]

第2章 - 章节标题
章节定位：[开篇引入/高潮爆发/转折过渡/...]
核心作用：[建立主角形象/揭示关键信息/推动主线发展/...]
悬念密度：[紧凑/渐进/爆发/...]
伏笔设计：埋设(A线索)→强化(B矛盾)→回收(C悬念)
转折程度：★☆☆☆☆
主角修为：表面修为[境界/等级] | 实际实力[隐藏境界/等级]
空间坐标：[区域范围/移动路线/具体地点]
章节简述：[1-2句话概括本章主要情节，包含：主要事件、关键角色、重要变化]

【格式要求】：
- 单元标记前后各加一个空行，确保与章节分隔
- 章节标题不使用任何markdown格式（不要加粗、不要方括号、不要星号）
- 格式严格为：第X章 - 标题文字
- 【强制要求】：必须在第一个章节之前生成第1单元信息，后续单元按顺序生成。单元信息必须包含所有字段，不得遗漏。

要求：
- 使用精炼语言描述，每章字数控制在150字以内。
- 合理安排节奏，严格遵循世界观，确保整体悬念曲线的连贯性。
- 在生成{number_of_chapters}章前不要出现结局章节。
- 单元信息要简洁明了，为每个单元推荐合适的跨章节写作手法。

注意：以上所有字段（单元信息和章节字段）都会被解析并用于后续章节生成，请确保每个字段都有明确的值。

仅给出最终文本，不要解释任何内容。
"""

chunked_chapter_blueprint_prompt = """\
基于以下元素：
- 内容指导：{user_guidance}
- 世界观：
{world_building}
- 小说架构：
{novel_architecture}

需要生成总共{number_of_chapters}章的节奏分布，

当前已有章节目录（若为空则说明是初始生成）：

{chapter_list}

现在请设计第{n}章到第{m}的节奏分布：

【单元信息】
{unit_info}

【生成要求】
{generation_requirements}

【强制约束条件】
1. 修为等级约束：
   - 每个章节的修为必须在所属单元的"修为等级范围"内
   - 表面修为和实际实力都必须在单元修为等级范围内
   - 修为变化必须在单元修为等级范围内循序渐进，不得超出范围

   【修为体系强制规范】：
   - 每个大境界的最高层为"大圆满"境界
   - 炼气期：炼气一层 → 炼气九层 → 炼气大圆满
   - 筑基期：筑基初期 → 筑基中期 → 筑基后期 → 筑基大圆满
   - 金丹期：金丹初期 → 金丹中期 → 金丹后期 → 金丹大圆满
   - 元婴期：元婴初期 → 元婴中期 → 元婴后期 → 元婴大圆满
   - 化神期：化神初期 → 化神中期 → 化神后期 → 化神大圆满
   - 合体期：合体初期 → 合体中期 → 合体后期 → 合体大圆满
   - 大乘期：大乘初期 → 大乘中期 → 大乘后期 → 大乘大圆满
   - 渡劫期：渡劫初期 → 渡劫中期 → 渡劫后期 → 渡劫大圆满
   - **严禁**：跳过大圆满境界直接突破大境界
   - **严禁**：大境界突破过于轻易，必须体现艰难过程

   【重要】：
   - 修为范围格式：[起始修为 → 结束修为]或[起始修为]（无变化）
   - 例如：[炼气一层 → 炼气三层] 表示整个单元内修为会从一层提升到三层
   - **【必须体现修为变化】**：如果单元范围承诺有突破（如一层→三层），章节中必须体现这个过程
   - **严禁**：所有章节都维持起始修为，而单元范围承诺有突破
   - **严禁**：章节修为超过单元范围的结束修为
   - **严禁**：章节修为低于单元范围的起始修为

   【修为变化示例】：
   单元修为范围：[炼气一层 → 炼气三层]
   第1章：实际实力[炼气一层]（开始）
   第2章：实际实力[炼气二层]（持续提升）
   第3章：实际实力[炼气三层]（战斗中突破）
   第4章：实际实力[炼气三层]（维持）

2. 空间坐标约束：
   - 每个章节的空间坐标必须在所属单元的"空间坐标范围"内
   - 空间移动路线必须在单元空间坐标范围内
   - 不得超出单元空间坐标范围移动

3. 章节生成要求：
   - 只生成章节信息，不要生成单元信息
   - 章节号必须严格按照第{n}章到第{m}的顺序生成
   - 生成的章节号必须严格对应{n}到{m}，不得使用其他章节号
   - 如果{n}到{m}范围内已有章节，请重新生成这些章节的内容
   - 确保每个章节的编号都是连续的，从{n}开始，到{m}结束

4. 每章需明确：
   - 章节定位：描述本章在整体剧情中的位置和作用（如"开篇引入"、"高潮爆发"、"转折过渡"等）
   - 核心作用：描述本章要实现的具体目标（如"建立主角形象"、"揭示关键信息"、"推动主线发展"等）
   - 悬念密度：描述本章的悬念紧张程度（如"紧凑"、"渐进"、"爆发"）
   - 伏笔设计（埋设/强化/回收）：
     * 埋设：首次引入某个线索或元素
     * 强化：对已埋设的线索进行加深或扩展
     * 回收：对已埋设的线索进行揭示或解决
     * 注意：伏笔的埋设和回收必须形成闭环，不能只有埋设没有回收
   - 转折程度强度：使用星级表示（如"★☆☆☆☆"表示1级，"★★★★★"表示5级）
   - 核心悬念类型：本章悬念类型（如"信息差"、"道德困境"、"时间压力"等）
   - 情感基调迁移：本章情感基调的变化（如"从怀疑→恐惧→决绝"）
   - 主角修为（表面修为与实际实力）- 必须在单元修为等级范围内
   - 空间坐标（区域范围/移动路线/具体地点）- 必须在单元空间坐标范围内

输出格式示例：

第1章 - 紫极光下的预兆
章节定位：开篇引入
核心作用：建立主角形象
悬念密度：渐进
伏笔设计：埋设(神秘紫极光)→强化(紫极光出现异常)→回收(紫极光吸收)
转折程度：★☆☆☆☆
核心悬念类型：信息差
情感基调迁移：好奇→担忧
主角修为：表面修为练气期三层 | 实际实力筑基期
空间坐标：青云宗入门广场→后山禁地
章节简述：主角发现紫极光异象，在后山禁地遭遇神秘力量。

第2章 - 章节标题
章节定位：[开篇引入/高潮爆发/转折过渡/...]
核心作用：[建立主角形象/揭示关键信息/推动主线发展/...]
悬念密度：[紧凑/渐进/爆发/...]
伏笔设计：埋设(A线索)→强化(B矛盾)→回收(C悬念)
转折程度：★☆☆☆☆
主角修为：表面修为[境界/等级] | 实际实力[隐藏境界/等级]
空间坐标：[区域范围/移动路线/具体地点]
章节简述：[1-2句话概括本章主要情节，包含：主要事件、关键角色、重要变化]

【格式要求】：
- 章节标题不使用任何markdown格式（不要加粗、不要方括号、不要星号）
- 格式严格为：第X章 - 标题文字
- 只生成章节信息，不要生成单元信息
- ⚠️ **非常重要：每章必须用空行与前后章节分隔！**
- ⚠️ 不要在章节之间添加其他分隔符（如"---"、空行以外的任何文字）
- 确保格式严格，便于后续解析和保存

示例格式：

第1章 - 紫极光下的预兆
章节定位：开篇引入
核心作用：建立主角形象
悬念密度：渐进
伏笔设计：埋设(神秘紫极光)→强化(紫极光出现异常)→回收(紫极光吸收)
转折程度：★☆☆☆☆
核心悬念类型：信息差
情感基调迁移：好奇→担忧
主角修为：表面修为练气期三层 | 实际实力筑基期
空间坐标：青云宗入门广场→后山禁地
章节简述：主角发现紫极光异象，在后山禁地遭遇神秘力量。

第2章 - 章节标题
章节定位：[开篇引入/高潮爆发/转折过渡/...]
核心作用：[建立主角形象/揭示关键信息/推动主线发展/...]
悬念密度：[紧凑/渐进/爆发/...]
伏笔设计：埋设(A线索)→强化(B矛盾)→回收(C悬念)
转折程度：★☆☆☆☆
主角修为：表面修为[境界/等级] | 实际实力[隐藏境界/等级]
空间坐标：[区域范围/移动路线/具体地点]
章节简述：[1-2句话概括本章主要情节，包含：主要事件、关键角色、重要变化]
"""

# =============== 单元生成提示词 ===================
unit_generation_prompt = """基于以下元素：
- 内容指导：{user_guidance}
- 世界观：
{world_building}
- 小说架构：
{novel_architecture}

需要生成总共{number_of_chapters}章的节奏分布。

当前已有章节目录（若为空则说明是初始生成）：

{chapter_list}

现在请为第{n}章到第{m}章设计单元划分：

【生成要求】
1. 单元划分原则：
- **单元章节数灵活划分**：根据故事情节需要划分单元，每个单元至少3章，上不封顶
- 划分依据：
  * 故事情节的完整性（一个完整的小故事弧）
  * 境界突破的需要（大境界突破单元需要更多章节铺垫）
  * 悬念设置的需要（复杂悬念需要更多章节展开）
  * 情感节奏的需要（高潮单元可适当延长）
- 每个单元需明确主角的修为等级范围和空间坐标范围，且范围适配整体小说架构
- 单元之间设置"认知过山车"（连续紧张→适当缓冲）
- 关键转折章需预留多视角铺垫

2. 每个单元必须包含以下结构化信息：
- 单元标题
- 包含章节范围（格式：n-m章，至少3章）
- 本单元定位
- 核心作用
- 内容摘要（必须准确概括该单元内所有章节的主要情节，不得与实际章节内容矛盾）
- 修为等级范围
- 空间坐标范围（必须包含：起始位置、移动路线、结束位置）
- 推荐的跨章节写作手法（必须包含：技法名称、应用方式、预期效果）

【修为体系强制规范】：
1. **大圆满境界**：每个大境界的最高层为"大圆满"境界
   - 炼气期：炼气一层 → 炼气九层 → 炼气大圆满
   - 筑基期：筑基初期 → 筑基中期 → 筑基后期 → 筑基大圆满
   - 金丹期：金丹初期 → 金丹中期 → 金丹后期 → 金丹大圆满
   - 元婴期：元婴初期 → 元婴中期 → 元婴后期 → 元婴大圆满
   - 化神期：化神初期 → 化神中期 → 化神后期 → 化神大圆满
   - 合体期：合体初期 → 合体中期 → 合体后期 → 合体大圆满
   - 大乘期：大乘初期 → 大乘中期 → 大乘后期 → 大乘大圆满
   - 渡劫期：渡劫初期 → 渡劫中期 → 渡劫后期 → 渡劫大圆满

2. **大境界突破要求**：
   - 从"大圆满"突破到下一大境界是极其艰难的过程
   - 必须安排多个章节（至少5章，境界越高越难突破）进行铺垫，包括：
     * 丹药/资源搜集（寻找突破所需的天材地宝）
     * 突破契机（机缘、顿悟、生死危机等触发条件）
     * 突破地点（灵气充裕之地、秘境、禁地、洞府密室等）
     * 突破过程（失败风险、心魔考验、外界干扰等）
   - 大境界突破应作为单元的高潮点，体现修仙之路的艰辛

3. **境界提升节奏规划**：
   - **并非每个单元都有境界提升**，要根据总章节数合理规划
   - 一般情况下，每15-25章安排一次小境界提升（如同境界内的层次提升）
   - 每40-60章安排一次大境界突破（需预留充足铺垫章节）
   - 大境界突破前应有至少1-2个单元的准备工作
   - 示例节奏（以100章为例）：
     * 第1-20章：炼气期内部提升（一层→九层→大圆满）
     * 第21-35章：筑基突破铺垫+突破
     * 第36-60章：筑基期成长
     * 第61-80章：金丹突破铺垫+突破
     * 第81-100章：金丹期成长

【重要提示】：
- 单元的"包含章节数"必须准确反映该单元实际包含的章节数
- 单元的"修为等级范围"必须准确反映该单元内所有章节的修为等级变化
- 章节生成时会严格遵循修为等级范围，不能全部维持最低修为
- 单元的"内容摘要"必须准确概括该单元内所有章节的主要情节，不得与实际章节内容矛盾
- 确保单元的编号连续，从{n}章开始，到{m}章结束
- 如果{n}到{m}范围内已有单元，请重新生成这些单元的内容
- 单元内容摘要应该是一个简洁的概述，而不是详细描述每个章节
- 修为等级范围：可以变化，也可以不变化。如果修为范围有变化（如炼气一层 → 炼气二层），章节中必须体现修为提升过程。

输出格式示例1（修为变化）：

第1单元 - 试炼之途（包含章节：1-3章）
本单元定位：开篇引入
核心作用：建立主角修为体系和世界观背景
内容摘要：主角进入宗门试炼，通过初试进入内门，结识伙伴并了解修仙界的残酷竞争规则。
修为等级范围：[炼气一层 → 炼气二层]  # 表示整个单元内修为会从练气一层提升到练气二层
空间坐标范围：青云宗外门广场 → 试炼场地 → 青云宗后山
推荐的跨章节写作手法：层层递进 - 通过初试、复试、决赛三个阶段，逐步提升紧张感 - 建立主角的成长节奏

输出格式示例2（修为不变化）：

第1单元 - 试炼之途（包含章节：1-3章）
本单元定位：开篇引入
核心作用：建立主角修为体系和世界观背景
内容摘要：主角进入宗门试炼，通过初试进入内门，结识伙伴并了解修仙界的残酷竞争规则。
修为等级范围：[炼气一层]  # 表示整个单元内修为保持练气一层
空间坐标范围：青云宗外门广场 → 试炼场地 → 青云宗后山
推荐的跨章节写作手法：层层递进 - 通过初试、复试、决赛三个阶段，逐步提升紧张感 - 建立主角的成长节奏

【修为变化示例】：
- 第1章：实际实力[炼气一层]（开始）
- 第2章：实际实力[炼气二层]（持续提升）
- 第3章：实际实力[炼气三层]（战斗中突破）

第2单元 - 筑基前奏（包含章节：18-22章）
本单元定位：大境界突破铺垫
核心作用：为炼气大圆满突破筑基做准备
内容摘要：主角达到炼气大圆满后，开始搜集筑基丹材料，寻找合适的突破地点，遭遇竞争对手阻挠。
修为等级范围：[炼气大圆满]  # 本单元无境界提升，维持大圆满状态
空间坐标范围：青云宗藏经阁 → 灵药园 → 后山禁地
推荐的跨章节写作手法：伏笔铺垫 - 暗示突破难度和所需资源 - 为后续突破制造期待感

第3单元 - 筑基突破（包含章节：23-27章）
本单元定位：大境界突破高潮
核心作用：完成炼气到筑基的大境界突破
内容摘要：主角在禁地中服下筑基丹，经历心魔考验，最终成功突破筑基期。
修为等级范围：[炼气大圆满 → 筑基初期]  # 大境界突破
空间坐标范围：后山禁地 → 突破密室
推荐的跨章节写作手法：高潮爆发 - 集中展现突破过程的艰难和主角的意志 - 完成阶段性成长

【格式要求】：
- 单元标记前后各加一个空行
- 格式严格为：第X单元 - 单元标题（包含章节：n-m章）
- "包含章节：n-m章"中的n和m必须是具体的章节号，不能是"3-5章"这样的范围描述

要求：
- 使用精炼语言描述，确保单元信息准确对应章节范围
- 合理安排节奏，严格遵循世界观，确保整体悬念曲线的连贯性
- 单元信息要简洁明了，为每个单元推荐合适的跨章节写作手法
- **严格遵守修为体系规范**，不得跳过大圆满境界，不得轻视大境界突破

注意：以上所有字段都会被解析并用于后续章节生成，请确保每个字段都有明确的值。

仅给出最终文本，不要解释任何内容。
"""

# =============== 6. 前文摘要更新 ===================
summary_prompt = """\
你是一位专业的小说编辑，擅长梳理复杂情节脉络及小说摘要，精准提炼关键信息。

## 输入信息

### 新章节信息
- 章节编号：{chapter_number}
- 章节标题：{chapter_title}
- 章节定位：{chapter_role}
- 核心作用：{chapter_purpose}

### 新章节文本
{chapter_text}

### 当前前文摘要
{global_summary}

### 章节元数据
- 主角修为：表面修为{surface_cultivation} | 实际实力{actual_cultivation}
- 空间坐标：{spatial_coordinates}
- 关键人物：{characters_involved}
- 关键道具：{key_items}

## 更新策略

### 新旧内容融合
1. 优先级排序
   - P0：主角核心进展（修为突破、关键机缘、重大决策）
   - P1：主线冲突发展（正邪对立、宗门矛盾、种族冲突）
   - P2：重要支线进展（人物关系、伏笔回收、世界观揭示）
   - P3：辅助信息补充（环境描述、背景信息、细节补充）

2. 内容融合规则
   - 保留前文摘要中所有P0和P1级别信息
   - 更新P0和P1级别信息的状态描述
   - 新增本章出现的P0-P3级别信息
   - 删除已被完全解决的P0-P1级别信息
   - 压缩P2和P3级别信息，确保摘要简洁

请根据本章新增内容，更新前文摘要。
要求：
- 保留既有重要信息，同时融入新剧情要点
- 以简洁、连贯的语言描述全书进展
- 客观描绘，不展开联想或解释
- 总字数控制在2000字以内

仅返回前文摘要文本，不要解释任何内容。
"""

# =============== 7. 角色状态更新 ===================
create_character_state_prompt = """\
你是一位专业的小说角色状态更新专家，擅长梳理复杂的唱片小说角色状态，精准提炼关键信息。
依据以下元素：
- 核心种子：{core_seed}
- 世界观：{world_building}
- 角色动力学设定：{character_dynamics}
- 最新章节正文：{latest_chapter}

用户内容要求：
{user_guidance}

请生成一个角色状态文档，内容格式：
例：
张三：
├──物品:
│  ├──青衫：一件破损的青色长袍，带有暗红色的污渍
│  └──寒铁长剑：一柄断裂的铁剑，剑身上刻有古老的符文
├──能力
│  ├──长春诀：木属性功法，能够让使用者在短时间内恢复伤势并提升身体素质，自带技能包括缠绕术、回春术和木甲术
│  └──六极真魔功：一种强大的攻击性功法，能够让使用者在短时间内提升攻击力和暴击率，自带技能包括魔爪术、魔影步和魔魂爆
├──状态
│  ├──身体状态: 身材挺拔，穿着华丽的铠甲，面色冷峻
│  └──心理状态: 目前的心态比较平静，但内心隐藏着对柳溪镇未来掌控的野心和不安
├──主要角色间关系网
│  ├──李四：张三从小就与她有关联，对她的成长一直保持关注
│  └──王二：两人之间有着复杂的过去，最近因一场冲突而让对方感到威胁
├──触发或加深的事件
│  ├──村庄内突然出现不明符号：这个不明符号似乎在暗示柳溪镇即将发生重大事件
│  └──李四被刺穿皮肤：这次事件让两人意识到对方的强大实力，促使他们迅速离开队伍

角色名：
├──物品
│  ├──某物(道具)：描述
│  └──XX长剑(武器)：描述
│   ...
├──能力
│  ├──技能1：描述
│  └──技能2：描述
│   ...
├──状态
│  ├──身体状态：
│  └──心理状态：描述
│    
├──主要角色间关系网
│  ├──李四：描述
│  └──王二：描述
│   ...
├──触发或加深的事件
│  ├──事件1：描述
│  └──事件2：描述
    ...

新出场角色：
- (此处填写未来任何新增角色或临时出场人物的基本信息)

【重要限制规则】：
1. 触发或加深的事件：主要角色最多保留不重复的最重要20个事件和最近的20个事件，其他角色最多保留最近10个事件，删除较早的旧事件
2. 物品：保留核心物品，删除已失去/消耗的物品，删除与当前修为不适应的物品，新增获得的物品
3. 能力：保留核心能力，可适当合并相似能力
4. 状态：保持简洁，删除已过时的状态描述

要求：
仅按要求格式返回编写好的角色状态文本，不要解释任何内容。
"""

update_character_state_prompt = """\
以下是新完成的章节文本：
{chapter_text}

这是当前的角色状态文档：
{old_state}

请更新主要角色状态，内容格式：
例：
张三：
├──物品
│  ├──青衫：一件破损的青色长袍，带有暗红色的污渍
│  └──寒铁长剑：一柄断裂的铁剑，剑身上刻有古老的符文
├──能力
│  ├──长春诀：木属性功法，能够让使用者在短时间内恢复伤势并提升身体素质，自带技能包括缠绕术、回春术和木甲术
│  └──六极真魔功：一种强大的攻击性功法，能够让使用者在短时间内提升攻击力和暴击率，自带技能包括魔爪术、魔影步和魔魂爆
├──状态
│  ├──身体状态: 身材挺拔，穿着华丽的铠甲，面色冷峻
│  └──心理状态: 目前的心态比较平静，但内心隐藏着对柳溪镇未来掌控的野心和不安
├──主要角色间关系网
│  ├──李四：张三从小就与她有关联，对她的成长一直保持关注
│  └──王二：两人之间有着复杂的过去，最近因一场冲突而让对方感到威胁
├──触发或加深的事件
│  ├──村庄内突然出现不明符号：这个不明符号似乎在暗示柳溪镇即将发生重大事件
│  └──李四被刺穿皮肤：这次事件让两人意识到对方的强大实力，促使他们迅速离开队伍

角色名：
├──物品
│  ├──某物(道具)：描述
│  └──XX长剑(武器)：描述
│   ...
├──能力
│  ├──技能1：描述
│  └──技能2：描述
│   ...
├──状态
│  ├──身体状态：
│  └──心理状态：描述
│    
├──主要角色间关系网
│  ├──李四：描述
│  └──王二：描述
│   ...
├──触发或加深的事件
│  ├──事件1：描述
│  └──事件2：描述
    ...

......

新出场角色：
- 任何新增角色或临时出场人物的基本信息，简要描述即可，不要展开，淡出视线的角色可删除。

【重要限制规则】：
1. 触发或加深的事件：主要角色最多保留不重复的最重要20个事件和最近的20个事件，其他角色最多保留最近10个事件，删除较早的旧事件
2. 物品：保留核心物品，删除已失去/消耗的物品，删除与当前修为不适应的物品，新增获得的物品
3. 能力：保留核心能力，可适当合并相似能力
4. 状态：保持简洁，删除已过时的状态描述

要求：
- 请直接在已有文档基础上进行增删
- 不改变原有结构，语言尽量简洁、有条理
- 严格遵守上述限制规则

仅返回更新后的角色状态文本，不要解释任何内容。
"""

# =============== 8. 剧情要点更新 ===================
update_plot_arcs_prompt = """\
你是一个专业的小说作者，精通小说创作，擅长分析章节内容，识别并更新剧情要点和未解决冲突。
以下是新完成的章节文本：
{chapter_text}

这是当前已记录的剧情要点或未解决冲突（可能为空）：
{old_plot_arcs}

请根据本章新增内容，更新剧情要点或未解决冲突记录。

## 剧情要点分类
- 主线剧情：推动核心故事发展的关键事件
- 支线剧情：辅助主线发展、丰富世界观的内容
- 秘境/特殊场景：特定地点、秘境、副本等
- 人物关系：角色间关系的变化、冲突、和解等
- 伏笔/悬念：为后续剧情埋下的线索
- 未解决冲突：当前存在但尚未解决的矛盾或问题

## 重要程度分级
- 🔴 极高：影响核心剧情走向、决定角色命运
- 🟠 高：重要支线、关键角色发展
- 🟡 中：普通支线、一般角色发展
- 🟢 低：细节补充、背景设定

## 剧情要点格式
```
[重要程度] [剧情分类] 事件描述
├── 涉及角色：角色1、角色2...
├── 当前状态：未解决/已推进/已解决
├── 相关章节：第X章、第Y章...
└── 备注：补充说明（可选）
```

【重要限制规则】：
1. 删除所有"已解决"状态的条目
4. 相似的剧情要点可以合并
5. 总条目数控制在20条以内

## 更新要求
- 保留尚未解决的冲突或伏笔，更新其状态
- 添加本章新出现的剧情要点、冲突或需要后续跟进的事件
- 为每个条目标注合适的重要程度和剧情分类
- 标记已在本章得到解决或推进的条目
- 以简洁、有条理的方式呈现，便于后续章节参考
- 按重要程度从高到低排序，相同重要程度按剧情分类排序

仅返回更新后的剧情要点文本，不要解释任何内容。
"""

# =============== 9. 章节正文写作 ===================

# 8.1 第一章草稿提示
first_chapter_draft_prompt = """\
即将创作：第 {novel_number} 章《{chapter_title}》

{unit_info}

本章定位：{chapter_role}
核心作用：{chapter_purpose}
悬念密度：{suspense_level}
伏笔操作：{foreshadowing}
认知颠覆：{plot_twist_level}
主角修为：表面修为{surface_cultivation} | 实际实力{actual_cultivation}
本章简述：{chapter_summary}

可用元素：
- 核心人物(可能未指定)：{characters_involved}
- 关键道具(可能未指定)：{key_items}
- 空间坐标(可能未指定)：{scene_location}
- 时间压力(可能未指定)：{time_constraint}

参考文档：
- 小说设定：
{novel_setting}

- 剧情要点（未解决冲突、伏笔等）：
{plot_arcs}

- 知识库参考：（按优先级应用）
{filtered_context}

🎯 知识库元数据应用指导：
1. 元数据识别：
   - 【类型】识别内容属于玄幻修真或通用写作
   - 【分类】识别内容属于场景构建模板、悬念营造手法、对话写作技巧等
   - 【关键词】识别与内容相关的关键词组合

2. 元数据应用规则：
   - 优先使用【分类】与章节类型匹配的内容
   - 【关键词】与章节关键要素（人物、道具、场景）匹配的内容优先应用
   - 【类型】与小说类型匹配的内容优先应用

🎯 知识库应用规则：
1. 内容分级：
   - 写作技法类（优先）：
     ▸ 场景构建模板：适用于环境描写、场景转换、空间架构构建
     ▸ 对话写作技巧：适用于人物对话、潜台词表达、权力关系表现
     ▸ 悬念营造手法：适用于制造紧张感、设置悬念、情节转折
     ▸ 视角切换技巧：适用于视角转换、信息呈现、读者代入感增强
     ▸ 时间跳跃与回忆穿插：适用于时间线处理、回忆与现实的衔接
     ▸ 多线并进冲突集中爆发：适用于多线交织、冲突爆发、节奏控制
     ▸ 伏笔的长线铺设：适用于伏笔设置、情节铺垫、后续呼应
     ▸ 个人物品及状态盘点：适用于物品状态管理、人物性格刻画、情节推动
   - 设定资料类（选择性）：
     ▸ 独特世界观元素：适用于世界观构建、设定补充
     ▸ 未使用过的技术细节：适用于技术描述、流程说明
   - 禁忌项类（必须规避）：
     ▸ 与设定冲突的内容
     ▸ 重复的人物关系发展

2. 使用限制：
   ● 禁止直接复制已有章节的情节模式
   ● 第三方写作知识优先用于：
     → 增强场景表现力（占知识应用的60%以上）
     → 创新悬念设计（至少1处新技巧）
     - 优先用于增强而非重复

3. 冲突检测：
   ⚠️ 若检测到与设定冲突：
     - 必须重构叙事角度
     - 替换至少3个关键要素
     - 保留核心概念，改变表现形式

4. 融合度要求：
   ⚠️ 知识库内容融合度标准：
     - 高融合度：知识库内容自然融入章节，无明显痕迹
     - 中融合度：知识库内容有轻微调整后融入章节
     - 低融合度：知识库内容需要较大调整才能融入章节

   ⚠️ 融合度提升方法：
     - 根据章节人物性格调整知识库内容表达方式
     - 根据章节场景特点调整知识库内容应用方式
     - 根据章节情节发展调整知识库内容应用时机
     - 根据章节张力级别调整知识库内容应用强度

完成第 {novel_number} 章的正文，字数要求{word_number}字，至少设计下方2个或以上具有动态张力的场景：
1. 对话场景：
   - 潜台词冲突（表面谈论A，实际博弈B）
   - 权力关系变化（通过非对称对话长度体现）

2. 动作场景：
   - 环境交互细节（至少3个感官描写）
   - 节奏控制（短句加速+比喻减速）
   - 动作揭示人物隐藏特质

3. 心理场景：
   - 认知失调的具体表现（行为矛盾）
   - 隐喻系统的运用（连接世界观符号）
   - 决策前的价值天平描写

4. 环境场景：
   - 空间透视变化（宏观→微观→异常焦点）
   - 非常规感官组合（如"听见阳光的重量"）
   - 动态环境反映心理（环境与人物心理对应）

格式要求：
- 仅返回章节正文文本；
- 不使用分章节小标题；
- 不要使用markdown格式。

额外指导(可能未指定)：{user_guidance}
"""

# 8.2 后续章节草稿提示
next_chapter_draft_prompt = """\
参考文档：
└── 前文摘要：
    {global_summary}

└── 前章结尾段：
    {previous_chapter_excerpt}

└── 用户指导：
    {user_guidance}

└── 角色状态：
    {character_state}

└── 当前章节摘要：
    {short_summary}

└── 剧情要点（未解决冲突、伏笔等）：
    {plot_arcs}

当前章节信息：
第{novel_number}章《{chapter_title}》：
├── 章节定位：{chapter_role}
├── 核心作用：{chapter_purpose}
├── 悬念密度：{suspense_level}
├── 伏笔设计：{foreshadowing}
├── 转折程度：{plot_twist_level}
├── 主角修为：表面修为{surface_cultivation} | 实际实力{actual_cultivation}
├── 章节简述：{chapter_summary}
├── 字数要求：{word_number}字
├── 核心人物：{characters_involved}
├── 关键道具：{key_items}
├── 场景地点：{scene_location}
└── 时间压力：{time_constraint}

{unit_info}

下一章节目录
第{next_chapter_number}章《{next_chapter_title}》：
├── 章节定位：{next_chapter_role}
├── 核心作用：{next_chapter_purpose}
├── 悬念密度：{next_chapter_suspense_level}
├── 伏笔设计：{next_chapter_foreshadowing}
├── 转折程度：{next_chapter_plot_twist_level}
├── 主角修为：表面修为{next_surface_cultivation} | 实际实力{next_actual_cultivation}
├── 场景地点：{next_scene_location}
└── 章节简述：{next_chapter_summary}

知识库参考：（按优先级应用）
{filtered_context}

🎯 知识库元数据应用指导：
1. 元数据识别：
   - 【类型】识别内容属于玄幻修真或通用写作
   - 【分类】识别内容属于场景构建模板、悬念营造手法、对话写作技巧等
   - 【关键词】识别与内容相关的关键词组合

2. 元数据应用规则：
   - 优先使用【分类】与章节类型匹配的内容
   - 【关键词】与章节关键要素（人物、道具、场景）匹配的内容优先应用
   - 【类型】与小说类型匹配的内容优先应用

🎯 知识库应用规则：
1. 内容分级：
   - 写作技法类（优先）：
     ▸ 场景构建模板：适用于环境描写、场景转换、空间架构构建
     ▸ 对话写作技巧：适用于人物对话、潜台词表达、权力关系表现
     ▸ 悬念营造手法：适用于制造紧张感、设置悬念、情节转折
     ▸ 视角切换技巧：适用于视角转换、信息呈现、读者代入感增强
     ▸ 时间跳跃与回忆穿插：适用于时间线处理、回忆与现实的衔接
     ▸ 多线并进冲突集中爆发：适用于多线交织、冲突爆发、节奏控制
     ▸ 伏笔的长线铺设：适用于伏笔设置、情节铺垫、后续呼应
     ▸ 个人物品及状态盘点：适用于物品状态管理、人物性格刻画、情节推动
   - 设定资料类（选择性）：
     ▸ 独特世界观元素：适用于世界观构建、设定补充
     ▸ 未使用过的技术细节：适用于技术描述、流程说明
   - 禁忌项类（必须规避）：
     ▸ 已在前文出现过的特定情节
     ▸ 重复的人物关系发展

2. 使用限制：
   ● 禁止直接复制已有章节的情节模式
   ● 历史章节内容仅允许：
     → 参照叙事节奏（不超过20%相似度）
     → 延续必要的人物反应模式（需改编30%以上）
     - 仅在必要时引用，避免重复
   ● 第三方写作知识优先用于：
     → 增强场景表现力（占知识应用的60%以上）
     → 创新悬念设计（至少1处新技巧）
     - 优先用于增强而非重复

3. 冲突检测：
   ⚠️ 若检测到与历史章节重复：
     - 相似度>40%：必须重构叙事角度
     - 相似度20-40%：替换至少3个关键要素
     - 相似度<20%：保留核心概念，改变表现形式

4. 融合度要求：
   ⚠️ 知识库内容融合度标准：
     - 高融合度：知识库内容自然融入章节，无明显痕迹
     - 中融合度：知识库内容有轻微调整后融入章节
     - 低融合度：知识库内容需要较大调整才能融入章节

   ⚠️ 融合度提升方法：
     - 根据章节人物性格调整知识库内容表达方式
     - 根据章节场景特点调整知识库内容应用方式
     - 根据章节情节发展调整知识库内容应用时机
     - 根据章节张力级别调整知识库内容应用强度

依据前面所有设定，开始完成第 {novel_number} 章的正文，字数要求{word_number}字，

内容生成严格遵循：
-本章字数、修为等级、章节定位、核心作用、悬念密度、伏笔设计、转折程度等章节信息
-用户指导
-当前章节摘要
-当前章节信息
-参考文档中的前文摘要、前章结尾段、角色状态、剧情要点等内容
-知识库内容根据需要选用，但必须遵守应用规则，确保创新性和避免重复
-无逻辑漏洞，情节合理，人物行为符合设定

必须确保本章开头与前章结尾段衔接流畅，且不与上一章开头雷同。
必须确保本章内容与前文摘要、前章结尾段衔接流畅、下一章目录保证上下文完整性，

格式要求：
- 仅返回章节正文文本；
- 不使用分章节小标题；
- 不要使用markdown格式。
"""

Character_Import_Prompt = """\
根据以下文本内容，分析出所有角色及其属性信息，严格按照以下格式要求：

<<角色状态格式要求>>
1. 必须包含以下五个分类（按顺序）：
   ● 物品 ● 能力 ● 状态 ● 主要角色间关系网 ● 触发或加深的事件
2. 每个属性条目必须用【名称: 描述】格式
   例：├──青衫: 一件破损的青色长袍，带有暗红色的污渍
3. 状态必须包含：
   ● 身体状态: [当前身体状况]
   ● 心理状态: [当前心理状况]
4. 关系网格式：
   ● [角色名称]: [关系类型，如"竞争对手"/"盟友"]
5. 触发事件格式：
   ● [事件名称]: [简要描述及影响]

<<示例>>
李员外:
├──物品:
│  ├──青衫: 一件破损的青色长袍，带有暗红色污渍
│  └──寒铁长剑: 剑身有裂痕，刻有「青云」符文
├──能力:
│  ├──长春诀：木属性功法，能够让使用者在短时间内恢复伤势并提升身体素质，自带技能包括缠绕术、回春术和木甲术
│  └──六极真魔功：一种强大的攻击性功法，能够让使用者在短时间内提升攻击力和暴击率，自带技能包括魔爪术、魔影步和魔魂爆
├──状态:
│  ├──身体状态: 右臂有未愈合的刀伤
│  └──心理状态: 对苏明远的实力感到忌惮
├──主要角色间关系网:
│  ├──苏明远: 竞争对手，十年前的同僚
│  └──林婉儿: 暗中培养的继承人
├──触发或加深的事件:
│  ├──兵器库遇袭: 丢失三把传家宝剑，影响战力
│  └──匿名威胁信: 信纸带有檀香味，暗示内部泄密
│  └──林婉儿被绑架: 事件加深了与苏明远的敌对关系

请严格按上述格式分析以下内容：

【重要限制规则】：
1. 触发或加深的事件：主要角色最多保留不重复的最重要20个事件和最近的20个事件，其他角色最多保留最近10个事件，删除较早的旧事件
2. 物品：保留核心物品，删除已失去/消耗的物品，删除与当前修为不适应的物品，新增获得的物品
3. 能力：保留核心能力，可适当合并相似能力
4. 状态：保持简洁，删除已过时的状态描述

<<待分析小说文本开始>>
{content}
<<待分析小说文本结束>>
"""
